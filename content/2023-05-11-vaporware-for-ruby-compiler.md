+++

title = "趣味はvaporware造りです v.0.0.1"
date = 2023-05-25
comments = true
categories = "diary"
+++

[**RubyKaigi2023**](htttps://rubykaigi.org/2023)に行ってきたのは[別エントリ](/blog/2023/05/15/ruby-kaigi-2023-at-matsumoto/)にしたのでこのエントリでは [_LT_](https://rubykaigi.org/2023/presentations/lt/) で話しした内容の説明などをしていこうかと思います。

## Presentation

<iframe class="speakerdeck-iframe" style="border: 0px none; background: rgba(0, 0, 0, 0.1) padding-box; margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 420;" src="https://speakerdeck.com/player/59e0f2da2d014f3e9b1d1d7633ef000f" title="Building Ruby Native Extension using Ruby" allowfullscreen="true" data-ratio="1.3333333333333333" frameborder="0"></iframe>

## LT申し込みまで

[**RubyKaigi2023**](https://rubykaigi.org/2023) 松本でやるし発表もしたいが、ネタがないなとおもってたら本編の方の _CFP_[^cfp] が閉じられてた[^cfpdate]。
とはいえ今年は **COVID-19** の制限も無くなるから _LT_ あるとおもうので _LT_ 出せたらいいなあと考えてた。
そうこうしているうちに [**Ruby30th**](https://30.ruby.or.jp/) で今はまだないものだけど…って matz がいったものを造ろうとなりました。

_LT_ の応募サイト開くまでにネタが幸い見つけることができ、実装をはじめることにした。

## 実装

ということで、通るかどうかわからないですが、発表できるように準備をはじめました。
準備といっても実際は実装どこまでできましたーというような発表にする予定だったので
そのまま実装をしています。

実装予定は発表にもあった通り、以下の予定ですすめて、最後に [`fiddle`](https://docs.ruby-lang.org/ja/latest/library/fiddle.html) で読み込めるように実装していました。

1. 四則演算: `Integer` の計算ができること
1. 変数: 変数が使えること
1. 制御構文: `for` や `if` などの基本的な制御構文が使えること
1. メソッド: メソッドが定義でき、利用できこと

を目標に実装をすすめていましたのでそれぞれの進捗を

### 四則演算

とくに詰まる点もなく、_AST_ をもとに _assembler_ へ変換するだけでいけた。

### 変数

これが一番大変だった。[教科書](https://www.sigbus.info/compilerbook) を `cherry-picking` しながら進めてたために、
実装でわからん部分が出てきたのでインターネット介して `gdb` リモートデバッグの講習を受けながら実装。
もともとここか制御構文までで終わるだろうなあと予想してたが、`SEGV` 出しながらもなんとかくりあ。

### 制御構文

はじめは素直に `if` 文を実装。ここも上記の理由によりなんもわからんとなり、[別の人の実装](https://github.com/ktateish/9cc) を参考に実装。
`if` 文だけじゃつまんないというか、とくになにもできないのでループ文を追加しようとしました。
はじめは `for` 文を実装しようと考えましたが、なんとここで重大なことに気がつきました。
**Ruby** の `for` のことはなにもしらない。ということに。そういえば `for x in 1..10; puts x;end` とか書けるけど
そもそも `Range` クラスや `Array` 作る必要あるよな？ということで一旦 `for` はやめに。

ということでここは `while` 文を実装して、[**`fibonacci` 数**](https://ja.wikipedia.org/wiki/%E3%83%95%E3%82%A3%E3%83%9C%E3%83%8A%E3%83%83%E3%83%81%E6%95%B0) を求めることができるようになりました。

### メソッド

ここは変数、制御構文ができれば作るだけなら問題はなかったように思えます。
ただほんとうに作るだけだったので、引数なし、定数を返すだけのメソッドの確認しか行なっていないです。
ここの実装にたどり着くとは思っておらず、最後のRubyKaigi直前の6連休に入ってから実装できてしまったので
あんまりブラッシュアップできていないです。
引数の扱い、変数の利用、などなど確認をとれておらずにいますが動いたので `fiddle` で読み込めるように。

### Fiddle で利用できるようにする

定義したメソッドを **C言語** の関数として見えるようにしてあげればいいので、
そうしたら、あっさりとうごいてしまった[^yoteigai]。この時点で連休の終わりの方だったのは覚えている

## 発表準備

もともとGW前の連休には実装を終らせてGWの連休中に発表資料作成とできたところまでの実装のブラッシュアップを
行なう予定でしたが、目標の実装が見えてるとなるとどうしても実装したくなって実装の方を進めてました。

もともと発表は [**Rabbit**](https://rabbit-shocker.org) を利用して英語で行う予定でしたが、LTはとくに
うちあわせのために資料を先に出すとかなかったのでとりあえず日本語で作成しました。
実装おわっていないというか実装に時間掛けすぎたのと、RubyKaigiへ持っていくPCをあたらしくしたので
冒険はできずに素直に [**Google スライド**](https://docs.google.com/presentation) 利用して作成、
後日 **Rabbit** で清書するということにしました。

発表資料自体は 5/8 or 5/9 ぐらいに作成し終っていました。デモなしで発表練習するとちょうど時間通りに
おわるのでこの資料作成完了時点ではこれでよしとしてました。
この時点でも資料はすくたなくとも英語にしようとは考えて資料は作成していました。

## 当日

当日の朝、資料作成というか資料の英語変換をやっていて、やっているうちに
実際発表してなにができてなにができてないみたいなこと言ったとしても
なにがなんだかわからんよなとなったので急遽デモをやって、実行できること示すように少し変更しました。

当日はセッションききながらかなり緊張していました、直前のセッションのトラブルもあったので。
聞いた人はわかるとおもうのですが、発表が途中でおわったのはこういった事情があったのでああいう発表になりました。

## 後日

発表当日の昼飯時に、 [@ukstudio](https://twitter.com/ukstudio) が [**cookpad**](https://cookpad.com) のイベントとして [**手を動かして振り返る RubyKaigi 2023**](https://cookpad.connpass.com/event/282436/) が5/18にあるからきてよと誘われたのでいくことにしました。
この会では、デキテイナカったデモを最後までやりきっています。

## 書き直し

**手を動かして~** のあとに **Rabbit** への清書を行ないました。
いままでもいくつかの発表は **Rabbit** でやってたのですが、
**Rabbit テーマ** を作りたい作りたいと思っていたので今回は時間もあるのでつくることにしました。
とはいってもほぼ [@yu_suke1994](https://twitter.com/yu_suke1994) の[リポジトリ](https://github.com/unasuke/rubykaigi-2023/)をコピーしただけなんでうが……

## まとめ

**RubyKaigi** の _LT_ で話ししたことをまとめました。
実装の話はもうちょっと詳しく書きたいけど、そもそも実装もすすめたいしでなかなか書けていないですね。

次回作もご期待ください 完

+++
[^cfp]: Call For Proposal。ずっと Call For Paper だとおもってたので知ったときえってなった。
[^cfpdate]: [2023-01-31](https://cfp.rubykaigi.org/events/2023) 締切で完全にネタない状態だった。
[^yoteigai]: もともとの発表予定ではここまでしかできなかったんですよーって濁す予定でしたが思っている以上に実装がすすんでしまった。
